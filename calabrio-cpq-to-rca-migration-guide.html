<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calabrio CPQ &rarr; RCA Product Migration Guide</title>
    <style>
        :root {
            --sf-blue: #0176d3;
            --sf-dark: #032d60;
            --sf-light: #f4f6f9;
            --sf-green: #2e844a;
            --sf-orange: #fe9339;
            --sf-red: #ea001e;
            --sf-purple: #730394;
            --sf-teal: #0d9dda;
            --border: #d8dde6;
            --text: #181818;
            --text-muted: #5a6872;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Salesforce Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--sf-light);
        }

        a { color: var(--sf-blue); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .hero {
            background: linear-gradient(135deg, #032d60 0%, #0176d3 50%, #1b96ff 100%);
            color: white;
            padding: 4rem 2rem 3rem;
            text-align: center;
        }

        .hero h1 { font-size: 2.8rem; margin-bottom: 0.5rem; font-weight: 800; }
        .hero .subtitle { font-size: 1.2rem; opacity: 0.9; margin-bottom: 1rem; }

        .hero .badges {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hero .badge {
            background: rgba(255,255,255,0.15);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            backdrop-filter: blur(4px);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        /* Navigation */
        .nav-bar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: padding 0.25s ease, border-radius 0.25s ease;
        }

        .nav-bar.collapsed {
            padding: 0.5rem 1.2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
        }

        .nav-bar h3 { color: var(--sf-dark); margin-bottom: 0.8rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; }

        .nav-bar .nav-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-bar.collapsed h3 { margin-bottom: 0; }

        .nav-toggle {
            display: none;
            background: var(--sf-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.25rem 0.7rem;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--sf-blue);
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }

        .nav-toggle:hover { background: var(--sf-blue); color: white; }

        .nav-bar.collapsed .nav-toggle { display: inline-flex; align-items: center; gap: 0.3rem; }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            transition: max-height 0.3s ease, opacity 0.25s ease;
            overflow: hidden;
        }

        .nav-bar.collapsed .nav-links {
            max-height: 0;
            opacity: 0;
            margin: 0;
        }

        .nav-bar.collapsed.expanded .nav-links {
            max-height: 500px;
            opacity: 1;
            margin-top: 0.6rem;
        }

        .nav-links a {
            padding: 0.4rem 0.9rem;
            background: var(--sf-light);
            border-radius: 6px;
            text-decoration: none;
            color: var(--sf-dark);
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-links a:hover { background: var(--sf-blue); color: white; }

        /* Sections */
        .section {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section h2 {
            color: var(--sf-dark);
            font-size: 1.6rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--sf-blue);
        }

        .section h3 {
            color: var(--sf-blue);
            margin: 1.8rem 0 0.8rem 0;
            font-size: 1.2rem;
        }

        .section h4 {
            color: var(--sf-dark);
            margin: 1.2rem 0 0.5rem 0;
            font-size: 1.05rem;
        }

        .section p { margin-bottom: 0.7rem; }
        .section ul, .section ol { padding-left: 1.5rem; margin-bottom: 1rem; }
        .section li { margin-bottom: 0.4rem; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.88rem;
        }

        th {
            background: var(--sf-dark);
            color: white;
            padding: 0.7rem 0.8rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        tr:nth-child(even) { background: #f8f9fb; }
        tr:hover { background: #e8f0fe; }

        /* Callout boxes */
        .callout {
            padding: 1rem 1.2rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .callout-blue { background: #f0f7ff; border-left: 4px solid var(--sf-blue); }
        .callout-green { background: #e8f5e9; border-left: 4px solid var(--sf-green); }
        .callout-orange { background: #fff8e1; border-left: 4px solid var(--sf-orange); }
        .callout-red { background: #ffeef0; border-left: 4px solid var(--sf-red); }

        .callout strong { display: block; margin-bottom: 0.3rem; }
        .callout-blue strong { color: var(--sf-blue); }
        .callout-green strong { color: var(--sf-green); }
        .callout-orange strong { color: #e65100; }
        .callout-red strong { color: var(--sf-red); }

        /* Diagrams */
        .diagram {
            margin: 1.5rem 0;
            text-align: center;
        }

        /* Code */
        code {
            background: #f0f2f5;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.85em;
            color: var(--sf-purple);
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.2rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.82rem;
            line-height: 1.5;
        }

        pre code { background: none; padding: 0; color: #e2e8f0; border: none; font-size: inherit; }

        /* Step numbers */
        .step-num {
            display: inline-block;
            width: 28px; height: 28px;
            background: var(--sf-blue);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: 700;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .step-header { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .step-header h3 { margin: 0; }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 0.1em 0.5em;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .tag-api { background: #e3f2fd; color: var(--sf-blue); }
        .tag-soql { background: #e8f5e9; color: var(--sf-green); }
        .tag-warn { background: #fff8e1; color: #e65100; }

        .field-table code { font-size: 0.8rem; }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--sf-blue);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            line-height: 48px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(1, 118, 211, 0.4);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s, background 0.2s;
            z-index: 999;
        }

        .back-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .back-to-top:hover {
            background: var(--sf-dark);
            box-shadow: 0 6px 16px rgba(3, 45, 96, 0.5);
        }

        /* Print Button */
        .print-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.4rem;
            background: var(--sf-dark);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            font-family: inherit;
        }

        .print-btn:hover { background: var(--sf-blue); transform: translateY(-1px); }
        .print-btn:active { transform: translateY(0); }

        .print-btn svg { width: 18px; height: 18px; fill: currentColor; }

        .print-bar-top {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        .print-bar-bottom {
            display: flex;
            justify-content: center;
            margin: 2rem 0 0.5rem;
        }

        /* Matrix Easter Egg */
        body.matrix-active {
            background: #000;
        }
        body.matrix-active .hero { position: relative; z-index: 1; }
        body.matrix-active .container { position: relative; z-index: 1; }
        body.matrix-active .nav-bar { z-index: 100; }
        body.matrix-active .section { position: relative; z-index: 1; }
        body.matrix-active .footer { position: relative; z-index: 1; background: #000; color: #ccc; }
        body.matrix-active .back-to-top { z-index: 1000; }
        body.matrix-active .print-bar-top,
        body.matrix-active .print-bar-bottom { position: relative; z-index: 1; }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; }
            .nav-bar { position: static; }
            .nav-bar.collapsed .nav-links { max-height: none; opacity: 1; }
            .nav-toggle { display: none !important; }
        }

        @media print {
            body { background: white !important; font-size: 10pt; line-height: 1.45; color: #000; }
            .container { max-width: 100%; padding: 0; margin: 0; }

            /* Hide interactive elements */
            .nav-bar, .back-to-top, .print-btn, .print-bar-top, .print-bar-bottom, #matrixCanvas { display: none !important; }

            /* Hero */
            .hero {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 1.5rem 1rem 1rem;
                break-after: avoid;
            }
            .hero h1 { font-size: 1.8rem; }
            .hero .subtitle { font-size: 1rem; }

            /* Sections */
            .section {
                box-shadow: none;
                border: 1px solid #ccc;
                border-radius: 0;
                padding: 1rem 1.2rem;
                margin-bottom: 0.8rem;
                break-inside: avoid;
            }
            .section h2 { font-size: 1.3rem; margin-bottom: 0.5rem; padding-bottom: 0.3rem; }
            .section h3 { font-size: 1.05rem; margin: 1rem 0 0.5rem; }
            .section h4 { font-size: 0.95rem; margin: 0.8rem 0 0.3rem; }

            /* Tables */
            table { font-size: 8.5pt; }
            th { -webkit-print-color-adjust: exact; print-color-adjust: exact; padding: 0.4rem 0.5rem; }
            td { padding: 0.3rem 0.5rem; }
            tr { break-inside: avoid; }

            /* SVG diagrams */
            svg { max-width: 100%; height: auto; break-inside: avoid; }

            /* Callouts */
            .callout {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                break-inside: avoid;
                padding: 0.6rem 0.8rem;
                margin: 0.5rem 0;
            }

            /* Code */
            code { font-size: 8pt; }
            pre { font-size: 7.5pt; break-inside: avoid; }

            /* Links */
            a[href^="http"]::after { content: " (" attr(href) ")"; font-size: 7.5pt; color: #666; word-break: break-all; }
            .nav-links a::after { content: none; }

            /* Footer */
            .footer { font-size: 8.5pt; break-before: avoid; }

            /* Reduce whitespace */
            .section p { margin-bottom: 0.3rem; }
            .section ul, .section ol { margin-bottom: 0.5rem; }
            .section li { margin-bottom: 0.2rem; }

            @page { margin: 0.6in 0.5in; }
        }
    </style>
</head>
<body>

<div class="hero">
    <h1>Calabrio CPQ to RCA Product Migration</h1>
    <div class="subtitle">Technical Guide &mdash; Salesforce Revenue Cloud Advanced (RCA)</div>
    <div class="badges">
        <span class="badge">CPQ &rarr; RCA Structure Migration</span>
        <span class="badge">Bundle Hierarchy &amp; Product Catalog</span>
        <span class="badge">Updated February 2026</span>
    </div>
    <div style="margin-top:0.6rem; font-size:0.85rem; opacity:0.8;">Prepared by Eddie Zaragoza &mdash; <a href="mailto:ezaragoza@crosscountry-consulting.com" style="color:white;">ezaragoza@crosscountry-consulting.com</a></div>
</div>

<div class="container">

    <!-- NAVIGATION -->
    <div class="nav-bar" id="navBar">
        <div class="nav-header">
            <h3>Quick Navigation</h3>
            <button class="nav-toggle" id="navToggle">&#9776; Show Links</button>
        </div>
        <div class="nav-links">
            <a href="#overview">Overview</a>
            <a href="#object-model">Object Model</a>
            <a href="#prerequisites">Prerequisites</a>
            <a href="#step1">Step 1: Extract</a>
            <a href="#step2">Step 2: Query Target</a>
            <a href="#step3">Step 3: Gap Analysis</a>
            <a href="#step4">Step 4: Products</a>
            <a href="#step5">Step 5: Groups</a>
            <a href="#step6">Step 6: L1 Rels</a>
            <a href="#step7">Step 7: L2 Rels</a>
            <a href="#step8">Step 8: Verify</a>
            <a href="#gotchas">Gotchas</a>
            <a href="#automation">Automation</a>
            <a href="#bundles">Bundle Inventory</a>
        </div>
    </div>

    <!-- PRINT BUTTON (TOP) -->
    <div class="print-bar-top">
        <button class="print-btn" onclick="window.print()">
            <svg viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
            Print to PDF
        </button>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- OVERVIEW -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="overview">
        <h2>1. Overview &amp; Architecture</h2>

        <p>This guide covers migrating Calabrio's product catalog from <strong>Salesforce CPQ (SBQQ)</strong> in the SIT sandbox to <strong>Revenue Cloud Advanced (RCA)</strong> in the RCADev org. The CPQ model uses <code>SBQQ__ProductOption__c</code> for bundle hierarchies, while RCA uses native Salesforce objects.</p>

        <p>The migration is <strong>structure-only</strong> &mdash; we replicate the bundle hierarchy (which products belong to which bundles, in which groups), not pricing rules, configuration rules, or enterprise product master records.</p>

        <div class="diagram" id="diagram-overview"></div>

        <h3>What Gets Migrated</h3>
        <table>
          <tr><th>Layer</th><th>Description</th><th>Example</th></tr>
          <tr><td>Parent Bundle</td><td>Top-level product package (PK-*)</td><td>PK-WFM (Workforce Management)</td></tr>
          <tr><td>L1 Children</td><td>Software, services, and custom services within a bundle</td><td>SW-CWFM-STND, PS-IMPL, TR-TRAINING</td></tr>
          <tr><td>L2 Children</td><td>Burst fees, billing options nested under L1 products</td><td>BF-CWFM &rarr; under SW-CWFM-STND</td></tr>
          <tr><td>Component Groups</td><td>Feature groupings within a bundle</td><td>"Software", "Services", "Custom Services"</td></tr>
        </table>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- OBJECT MODEL -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="object-model">
        <h2>2. Object Model Mapping (CPQ &rarr; RCA)</h2>

        <div class="diagram" id="diagram-mapping"></div>

        <table>
          <tr><th>CPQ Object</th><th>RCA Object</th><th>Notes</th></tr>
          <tr><td><code>Product2</code></td><td><code>Product2</code></td><td>Same object. RCA adds <code>Type</code> picklist (Bundle/Set/Base).</td></tr>
          <tr><td><code>SBQQ__ProductOption__c</code></td><td><code>ProductRelatedComponent</code></td><td>Bundle &rarr; child relationship. One record per link.</td></tr>
          <tr><td><code>SBQQ__ProductFeature__c</code></td><td><code>ProductComponentGroup</code></td><td>Groups children within a bundle (e.g., "Software").</td></tr>
          <tr><td><code>PricebookEntry</code></td><td><code>PricebookEntry</code></td><td>Same object. $0 entries for bundle parents.</td></tr>
          <tr><td>N/A</td><td><code>ProductRelationshipType</code></td><td>RCA-specific. Defines the type of link (e.g., "Bundle to Bundle Component").</td></tr>
          <tr><td><code>SBQQ__ConsumptionSchedule__c</code></td><td><code>ConsumptionSchedule</code></td><td>Burst fee tiered pricing. Separate migration step.</td></tr>
        </table>

        <h3>Key Field Mapping &mdash; ProductRelatedComponent</h3>
        <table class="field-table">
          <tr><th>Field (API Name)</th><th>Type</th><th>Required</th><th>Description</th></tr>
          <tr><td><code>ParentProductId</code></td><td>Reference</td><td>Yes</td><td>The bundle product</td></tr>
          <tr><td><code>ChildProductId</code></td><td>Reference</td><td>Yes*</td><td>The child product. <span class="tag tag-warn">NOT AssociatedProductId</span></td></tr>
          <tr><td><code>ProductRelationshipTypeId</code></td><td>Reference</td><td>Yes</td><td>Link to ProductRelationshipType</td></tr>
          <tr><td><code>ProductComponentGroupId</code></td><td>Reference</td><td>No</td><td>Optional grouping</td></tr>
          <tr><td><code>DoesBundlePriceIncludeChild</code></td><td>Boolean</td><td>Yes</td><td>Typically <code>false</code></td></tr>
          <tr><td><code>IsComponentRequired</code></td><td>Boolean</td><td>Yes</td><td>Typically <code>false</code></td></tr>
          <tr><td><code>IsQuantityEditable</code></td><td>Boolean</td><td>Yes</td><td>Must be <code>false</code> for Static bundles</td></tr>
          <tr><td><code>IsDefaultComponent</code></td><td>Boolean</td><td>Yes</td><td>Typically <code>true</code></td></tr>
        </table>

        <div class="callout callout-orange">
          <strong>Field Name Warning</strong>
          <code>AssociatedProductId</code> works in SOQL relationship queries but is <strong>NOT</strong> the correct field for inserts. The DML/API create field is <code>ChildProductId</code>. Using the wrong name causes silent failures in bulk operations and explicit errors in REST calls.
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- PREREQUISITES -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="prerequisites">
        <h2>3. Prerequisites</h2>
        <ul>
          <li><strong>sf CLI v2</strong> authenticated to both source (SIT) and target (RCADev) orgs</li>
          <li><strong>Python 3.8+</strong> with standard library (no pip packages required)</li>
          <li>Admin-level access in both orgs (Product2, PricebookEntry, ProductRelatedComponent CRUD)</li>
          <li>The <code>ProductRelationshipType</code> record "Bundle to Bundle Component Relationship" must exist in the target org</li>
        </ul>

        <pre><code># Verify org connections
sf org list | grep -E "SIT|RCADev"

# Check relationship types exist
sf data query -o RCADev -q "SELECT Id, Name FROM ProductRelationshipType"</code></pre>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 1 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step1">
        <h2>4. Step 1 &mdash; Extract Source Data from SIT</h2>

        <div class="step-header"><span class="step-num">1</span><h3>Query all ProductOptions from SIT</h3></div>

        <p>Pull the complete CPQ bundle hierarchy. This captures every parent&rarr;child relationship across all bundles.</p>

        <pre><code>sf data query -o SIT \
  -q "SELECT Id,
        SBQQ__ConfiguredSKU__r.ProductCode,
        SBQQ__ConfiguredSKU__r.Name,
        SBQQ__OptionalSKU__r.ProductCode,
        SBQQ__OptionalSKU__r.Name,
        SBQQ__Feature__r.Name,
        SBQQ__Type__c
      FROM SBQQ__ProductOption__c
      ORDER BY SBQQ__ConfiguredSKU__r.ProductCode" \
  --json > sit-product-options.json</code></pre>

        <p>This returns ~1,051 records across ~100 parent products. The key fields:</p>
        <ul>
          <li><code>SBQQ__ConfiguredSKU__r.ProductCode</code> &rarr; Parent bundle code</li>
          <li><code>SBQQ__OptionalSKU__r.ProductCode</code> &rarr; Child product code</li>
          <li><code>SBQQ__Feature__r.Name</code> &rarr; Maps to ComponentGroup name ("Software", "Services", etc.)</li>
        </ul>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 2 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step2">
        <h2>5. Step 2 &mdash; Query Target Org State</h2>

        <div class="step-header"><span class="step-num">2</span><h3>Pull current RCADev inventory</h3></div>

        <p>Query three objects to understand what already exists:</p>

        <pre><code># Products
sf data query -o RCADev \
  -q "SELECT Id, ProductCode, Name, Family, Type, IsActive
      FROM Product2 ORDER BY ProductCode" --json

# Component Groups
sf data query -o RCADev \
  -q "SELECT Id, Name, ParentProductId, ParentProduct.ProductCode
      FROM ProductComponentGroup
      ORDER BY ParentProduct.ProductCode, Name" --json

# Existing Relationships
sf data query -o RCADev \
  -q "SELECT Id, ParentProduct.ProductCode, ChildProduct.ProductCode,
             ProductComponentGroup.Name
      FROM ProductRelatedComponent
      ORDER BY ParentProduct.ProductCode" --json</code></pre>

        <p>Build lookup dictionaries:</p>
        <ul>
          <li><code>prod_by_code</code>: ProductCode &rarr; Product2 record (with Id)</li>
          <li><code>group_lookup</code>: (ParentProductCode, GroupName) &rarr; GroupId</li>
          <li><code>existing_rels</code>: Set of (ParentCode, ChildCode) tuples</li>
        </ul>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 3 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step3">
        <h2>6. Step 3 &mdash; Gap Analysis</h2>

        <div class="step-header"><span class="step-num">3</span><h3>Compare SIT hierarchy vs RCADev state</h3></div>

        <p>For each bundle being migrated, identify:</p>

        <table>
          <tr><th>Check</th><th>Action if Missing</th></tr>
          <tr><td>Parent bundle product exists?</td><td>Create Product2 with <code>Type='Bundle'</code></td></tr>
          <tr><td>Each L1 child product exists?</td><td>Create Product2 (set Type appropriately)</td></tr>
          <tr><td>Each L2 child product exists?</td><td>Create Product2 (burst fees typically have no Type)</td></tr>
          <tr><td>PricebookEntries for new products?</td><td>Create $0 Standard PBE for each new product</td></tr>
          <tr><td>Component groups on parent?</td><td>Create ProductComponentGroup</td></tr>
          <tr><td>Component groups on L2 sub-bundles?</td><td>Create "Burst Fees" or "Billing" group</td></tr>
          <tr><td>L1 relationships exist?</td><td>Create ProductRelatedComponent</td></tr>
          <tr><td>L2 relationships exist?</td><td>Create ProductRelatedComponent</td></tr>
        </table>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 4 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step4">
        <h2>7. Step 4 &mdash; Create Missing Products</h2>

        <div class="step-header"><span class="step-num">4</span><h3>Create Product2 records</h3></div>

        <pre><code># Via sf CLI
sf data create record -o RCADev -s Product2 \
  -v "ProductCode='SW-BOTANA' Name='Bot Analytics' Type='Bundle' Family='Analytics' IsActive=true"

# Via REST API (preferred for programmatic use)
curl -X POST "$INSTANCE_URL/services/data/v62.0/sobjects/Product2" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ProductCode": "SW-BOTANA",
    "Name": "Bot Analytics",
    "Type": "Bundle",
    "Family": "Analytics",
    "IsActive": true
  }'</code></pre>

        <div class="callout callout-red">
          <strong>Product2.Type is IMMUTABLE</strong>
          <p>The <code>Type</code> field on Product2 is <strong>Createable but NOT Updateable</strong>. Once a product is created, you cannot change its Type through any means &mdash; API, Apex, Tooling API, or anonymous Apex. All attempts return <code>Field is not writeable: Product2.Type</code>.</p>
          <p><strong>If you create a product without <code>Type='Bundle'</code>, you must delete and recreate it.</strong> This means also deleting and recreating any PricebookEntries and ProductRelatedComponent records that reference it.</p>
        </div>

        <h4>Product Type Rules</h4>
        <ul>
          <li><code>PK-*</code> (parent bundles) &rarr; <code>Type='Bundle'</code></li>
          <li><code>SW-*</code> (software products with burst fee children) &rarr; <code>Type='Bundle'</code></li>
          <li><code>PS-*</code> (service products with billing children) &rarr; <code>Type='Bundle'</code></li>
          <li><code>TR-*</code> (training products with billing children) &rarr; <code>Type='Bundle'</code></li>
          <li><code>BF-*</code> (burst fee leaf products) &rarr; <code>Type='Bundle'</code> or omit</li>
        </ul>

        <p>After creating each product, create a <strong>$0 Standard PricebookEntry</strong>:</p>
        <pre><code>curl -X POST "$INSTANCE_URL/services/data/v62.0/sobjects/PricebookEntry" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "Product2Id": "&lt;new_product_id&gt;",
    "Pricebook2Id": "&lt;standard_pricebook_id&gt;",
    "UnitPrice": 0,
    "IsActive": true
  }'</code></pre>

        <div class="callout callout-blue">
          <strong>Finding the Standard Pricebook ID</strong>
          <pre><code>sf data query -o RCADev -q "SELECT Id FROM Pricebook2 WHERE IsStandard = true"</code></pre>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 5 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step5">
        <h2>8. Step 5 &mdash; Create Component Groups</h2>

        <div class="step-header"><span class="step-num">5</span><h3>Create ProductComponentGroup records</h3></div>

        <p>Each bundle needs groups that organize its children. The CPQ <code>Feature</code> name maps directly to the RCA group name.</p>

        <table>
          <tr><th>CPQ Feature Name</th><th>RCA Group Name</th><th>Used On</th></tr>
          <tr><td>Software</td><td>Software</td><td>PK-* parent bundles</td></tr>
          <tr><td>Services</td><td>Services</td><td>PK-* parent bundles</td></tr>
          <tr><td>Custom Services</td><td>Custom Services</td><td>PK-* parent bundles</td></tr>
          <tr><td>(burst fee children)</td><td>Burst Fees</td><td>SW-* sub-bundles</td></tr>
          <tr><td>(billing children)</td><td>Billing</td><td>PS-*/TR-* sub-bundles</td></tr>
          <tr><td>(mixed children)</td><td>Options</td><td>PS-IMPL and similar</td></tr>
        </table>

        <pre><code>curl -X POST "$INSTANCE_URL/services/data/v62.0/sobjects/ProductComponentGroup" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "Name": "Software",
    "ParentProductId": "&lt;bundle_product_id&gt;"
  }'</code></pre>

        <div class="callout callout-orange">
          <strong>Parent Must Have Type Set</strong>
          <p>Creating a ProductComponentGroup requires the parent product to have a non-null <code>Type</code> field. If Type is null, you'll get: <code>"Parent product type should not be null."</code></p>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 6 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step6">
        <h2>9. Step 6 &mdash; Create L1 Relationships</h2>

        <div class="step-header"><span class="step-num">6</span><h3>Link bundle parents to L1 children</h3></div>

        <p>For each child in the SIT <code>ProductOption</code> where the parent is a <code>PK-*</code> bundle, create a <code>ProductRelatedComponent</code>.</p>

        <pre><code>curl -X POST "$INSTANCE_URL/services/data/v62.0/sobjects/ProductRelatedComponent" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ParentProductId": "&lt;bundle_id&gt;",
    "ChildProductId": "&lt;child_product_id&gt;",
    "ProductRelationshipTypeId": "&lt;rel_type_id&gt;",
    "ProductComponentGroupId": "&lt;group_id&gt;",
    "DoesBundlePriceIncludeChild": false,
    "IsComponentRequired": false,
    "IsQuantityEditable": false,
    "IsDefaultComponent": true
  }'</code></pre>

        <div class="callout callout-red">
          <strong>Static Bundle Constraint</strong>
          <p>Products with <code>Type='Bundle'</code> are treated as "Static" bundles. For their child relationships, <code>IsQuantityEditable</code> <strong>must be <code>false</code></strong>. Setting it to <code>true</code> returns: <code>"Quantity cannot be changed at runtime for a Static Parent Product."</code></p>
          <p>Use <code>IsQuantityEditable=false</code> as the safe default for all relationships.</p>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 7 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step7">
        <h2>10. Step 7 &mdash; Create L2 Relationships</h2>

        <div class="step-header"><span class="step-num">7</span><h3>Link sub-bundles to burst fees &amp; billing products</h3></div>

        <p>L2 relationships are children-of-children. For example:</p>
        <ul>
          <li><code>PK-WFM</code> &rarr; <code>SW-CWFM-STND</code> (L1) &rarr; <code>BF-CWFM</code> (L2 burst fee)</li>
          <li><code>PK-CQM</code> &rarr; <code>PS-IMPL</code> (L1) &rarr; <code>PS-PC-Billing</code> + <code>PS-UP-Billing</code> (L2 billing)</li>
        </ul>

        <p>The process is identical to Step 6 &mdash; create <code>ProductRelatedComponent</code> records. The parent is the L1 product, and the child is the burst fee or billing product.</p>

        <p>Ensure each L2 parent has a component group first ("Burst Fees" for <code>SW-*</code> parents, "Billing" for <code>PS-*</code>/<code>TR-*</code> parents).</p>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- STEP 8 -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="step8">
        <h2>11. Step 8 &mdash; Verification</h2>

        <div class="step-header"><span class="step-num">8</span><h3>Validate the migration</h3></div>

        <pre><code># Count total relationships
sf data query -o RCADev \
  -q "SELECT COUNT(Id) FROM ProductRelatedComponent"

# Check specific bundle
sf data query -o RCADev \
  -q "SELECT ChildProduct.ProductCode, ProductComponentGroup.Name
      FROM ProductRelatedComponent
      WHERE ParentProduct.ProductCode = 'PK-WFM'
      ORDER BY ProductComponentGroup.Name, ChildProduct.ProductCode"</code></pre>

        <p>Compare the count and child codes against the SIT source data. Every <code>ProductOption</code> for the migrated bundle should have a corresponding <code>ProductRelatedComponent</code> in RCADev.</p>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- GOTCHAS -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="gotchas">
        <h2>12. Critical Gotchas &amp; Lessons Learned</h2>

        <div class="callout callout-red">
          <strong>1. Product2.Type is Immutable</strong>
          <p><code>Createable: true, Updateable: false</code>. Not changeable via API, Apex, or Tooling API. Delete and recreate if wrong. This cascade-deletes PBEs and relationships too.</p>
        </div>

        <div class="callout callout-red">
          <strong>2. ChildProductId vs AssociatedProductId</strong>
          <p>SOQL uses the relationship name <code>AssociatedProduct</code> in queries, but the DML insert field is <code>ChildProductId</code>. The Bulk API may silently accept the wrong field name while creating zero records.</p>
        </div>

        <div class="callout callout-orange">
          <strong>3. IsQuantityEditable Must Be false for Static Bundles</strong>
          <p>Any product with <code>Type='Bundle'</code> is a Static bundle. Child relationships must have <code>IsQuantityEditable=false</code> or insertion fails.</p>
        </div>

        <div class="callout callout-orange">
          <strong>4. ComponentGroup Requires Parent Type</strong>
          <p>You cannot create a <code>ProductComponentGroup</code> on a product with <code>Type=null</code>. Set the Type at product creation time.</p>
        </div>

        <div class="callout callout-orange">
          <strong>5. Bulk API Result Parsing is Unreliable</strong>
          <p><code>sf data import bulk</code> may return <code>success=0, failed=0</code> even when records are created. Always verify with a follow-up SOQL count. For smaller batches (&lt;200), use REST API directly for reliable feedback.</p>
        </div>

        <div class="callout callout-blue">
          <strong>6. Standard Pricebook ID Varies by Org</strong>
          <p>Always query <code>SELECT Id FROM Pricebook2 WHERE IsStandard = true</code> rather than hardcoding. The ID differs across orgs/sandboxes.</p>
        </div>

        <div class="callout callout-blue">
          <strong>7. ProductComponentGroupId is Optional</strong>
          <p>Relationships can be created without a group. This is useful if the parent product can't have groups created on it (e.g., Type is null and can't be fixed).</p>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- AUTOMATION -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="automation">
        <h2>13. Automation Script Reference</h2>

        <p>A reusable Python script handles end-to-end migration for any bundle:</p>

        <pre><code># List available bundles
python3 calabrio-bundle-migrate.py --list

# Dry run (shows what would be created, no changes)
python3 calabrio-bundle-migrate.py PK-BA PK-CR PK-ONE --dry-run

# Execute migration
python3 calabrio-bundle-migrate.py PK-BA PK-CR PK-ONE</code></pre>

        <h3>What the Script Does</h3>
        <ol>
          <li>Loads cached SIT ProductOption data from JSON</li>
          <li>Queries RCADev for current products, groups, and relationships</li>
          <li>Identifies gaps (missing products, groups, relationships)</li>
          <li>Creates missing Product2 records with correct <code>Type='Bundle'</code></li>
          <li>Creates $0 PricebookEntries for new products</li>
          <li>Creates ProductComponentGroups on parent bundles</li>
          <li>Creates L1 ProductRelatedComponent records (bundle &rarr; children)</li>
          <li>Creates L2 ProductRelatedComponent records (sub-bundles &rarr; burst fees/billing)</li>
          <li>Skips already-existing records (safe to re-run)</li>
        </ol>

        <h3>Script Dependencies</h3>
        <ul>
          <li><code>sf</code> CLI authenticated to RCADev</li>
          <li><code>curl</code> (for REST API calls)</li>
          <li>Python 3.8+ (standard library only)</li>
          <li><code>/mnt/c/projects/sit-product-options-fresh.json</code> &mdash; cached SIT data</li>
        </ul>
    </div>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- BUNDLES -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <div class="section" id="bundles">
        <h2>14. Bundle Inventory</h2>

        <table>
          <tr><th>Bundle</th><th>Name</th><th>L1 Children</th><th>L2 Relationships</th><th>Status</th></tr>
          <tr><td><code>PK-WFM</code></td><td>Workforce Management</td><td>35</td><td>~50</td><td style="color:var(--sf-green)">Complete</td></tr>
          <tr><td><code>PK-CQM</code></td><td>Quality Management</td><td>57</td><td>~85</td><td style="color:var(--sf-green)">Complete</td></tr>
          <tr><td><code>PK-BA</code></td><td>Bot Analytics</td><td>7</td><td>7</td><td style="color:var(--sf-orange)">Ready</td></tr>
          <tr><td><code>PK-CR</code></td><td>Call Recording</td><td>9</td><td>12</td><td style="color:var(--sf-orange)">Ready</td></tr>
          <tr><td><code>PK-ONE</code></td><td>Calabrio ONE</td><td>42</td><td>45</td><td style="color:var(--sf-orange)">Ready</td></tr>
          <tr><td><code>LEGACY-WR</code></td><td>Legacy SKU Wrapper</td><td>737</td><td>N/A</td><td style="color:var(--text-muted)">Not migrating</td></tr>
        </table>

        <h3>PK-BA &mdash; New Products Needed</h3>
        <p>2 products: <code>SW-BOTANA</code> (Bot Analytics), <code>BF-BOTANA</code> (burst fee)</p>

        <h3>PK-CR &mdash; New Products Needed</h3>
        <p>2 products: <code>SW-CQMCR</code> (Call Recording), <code>BF-CQMCR</code> (burst fee)</p>

        <h3>PK-ONE &mdash; New Products Needed</h3>
        <p>26 products total:</p>
        <ul>
          <li><strong>15 L1:</strong> SW-CALONE, SW-CALONE-ENT, SW-CALONE-ENT400/800/1600, SW-CALONE-ENT-10K, SW-CALONE-ENTPLUS-10K, SW-CALONE-ESS-10K, SW-ONEARX, SW-ONELAB, PS-ADDLACD, PS-CALONE-ENT-IMPL, PS-CALONE-ENTUPG-IMPL, PS-ONESRV-UPGRD, TR-CALONE-ENT-TRAINING</li>
          <li><strong>11 L2 burst fees:</strong> BF-CALONE, BF-CALONE-ENT, BF-CALONE-ENT400/800/1600, BF-CALONE-ENT-USER, BF-CALONE-ENT-INT, BF-CALONE-ENTPLUS-USER, BF-CALONE-ENTPLUS-INT, BF-CALONE-ESS-USER, BF-CALONE-ESS-INT</li>
        </ul>
    </div>

    <!-- PRINT BUTTON (BOTTOM) -->
    <div class="print-bar-bottom">
        <button class="print-btn" onclick="window.print()">
            <svg viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
            Print to PDF
        </button>
    </div>

</div>

<div class="footer">
    <p>Calabrio CPQ to RCA Product Migration &mdash; Technical Guide</p>
    <p>Prepared by Eddie Zaragoza &mdash; <a href="mailto:ezaragoza@crosscountry-consulting.com" style="color:var(--sf-blue);">ezaragoza@crosscountry-consulting.com</a></p>
    <p>Generated February 2026</p>
</div>

<button class="back-to-top" id="backToTop" title="Back to top">&#8593;</button>

<script>
    // ── Back to Top Button ──
    const btn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
        btn.classList.toggle('visible', window.scrollY > 400);
    });
    btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ── Collapsible sticky nav ──
    (function() {
        const nav = document.getElementById('navBar');
        const toggle = document.getElementById('navToggle');
        const SCROLL_THRESHOLD = 120;

        window.addEventListener('scroll', () => {
            if (window.scrollY > SCROLL_THRESHOLD) {
                if (!nav.classList.contains('collapsed')) {
                    nav.classList.add('collapsed');
                    nav.classList.remove('expanded');
                    toggle.innerHTML = '&#9776; Show Links';
                }
            } else {
                nav.classList.remove('collapsed', 'expanded');
            }
        }, { passive: true });

        toggle.addEventListener('click', () => {
            const isExpanded = nav.classList.toggle('expanded');
            toggle.innerHTML = isExpanded ? '&#10005; Hide Links' : '&#9776; Show Links';
        });

        // Auto-collapse after clicking a nav link
        nav.querySelector('.nav-links').addEventListener('click', (e) => {
            if (e.target.tagName === 'A' && nav.classList.contains('collapsed')) {
                nav.classList.remove('expanded');
                toggle.innerHTML = '&#9776; Show Links';
            }
        });
    })();

    // ── SVG Diagram: Overview ──
    (function() {
      const container = document.getElementById('diagram-overview');
      const w = 900, h = 320;
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', w);
      svg.setAttribute('height', h);
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.style.maxWidth = '100%';

      const boxes = [
        { x: 350, y: 10,  w: 200, h: 44, text: 'PK-WFM (Bundle)', color: '#58a6ff', level: 'L0' },
        { x: 30,  y: 100, w: 180, h: 40, text: 'Custom Services (4)', color: '#d29922', level: 'L1' },
        { x: 240, y: 100, w: 160, h: 40, text: 'Services (10)', color: '#d29922', level: 'L1' },
        { x: 430, y: 100, w: 180, h: 40, text: 'Software (21)', color: '#d29922', level: 'L1' },
        { x: 640, y: 100, w: 220, h: 40, text: 'Component Groups', color: '#30363d', level: 'label' },
        { x: 50,  y: 180, w: 160, h: 36, text: 'PS-CUSTSVCS-STND', color: '#3fb950', level: 'L1p' },
        { x: 250, y: 180, w: 160, h: 36, text: 'PS-IMPL', color: '#3fb950', level: 'L1p' },
        { x: 450, y: 180, w: 175, h: 36, text: 'SW-CWFM-STND', color: '#3fb950', level: 'L1p' },
        { x: 665, y: 180, w: 175, h: 36, text: 'SW-CWFMVAP', color: '#3fb950', level: 'L1p' },
        { x: 55,  y: 260, w: 150, h: 34, text: 'PS-PC-Billing', color: '#f85149', level: 'L2' },
        { x: 255, y: 260, w: 150, h: 34, text: 'PS-UP-Billing', color: '#f85149', level: 'L2' },
        { x: 460, y: 260, w: 155, h: 34, text: 'BF-CWFM', color: '#f85149', level: 'L2' },
        { x: 670, y: 260, w: 165, h: 34, text: 'BF-CWFVAP', color: '#f85149', level: 'L2' },
      ];

      const connections = [
        [0, 1], [0, 2], [0, 3],
        [1, 5], [2, 6], [3, 7], [3, 8],
        [5, 9], [6, 10], [7, 11], [8, 12]
      ];

      // Draw connections
      connections.forEach(([fi, ti]) => {
        const f = boxes[fi], t = boxes[ti];
        const x1 = f.x + f.w / 2, y1 = f.y + f.h;
        const x2 = t.x + t.w / 2, y2 = t.y;
        const mid = (y1 + y2) / 2;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M${x1},${y1} C${x1},${mid} ${x2},${mid} ${x2},${y2}`);
        path.setAttribute('stroke', '#30363d');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        path.setAttribute('marker-end', 'url(#arrow)');
        svg.appendChild(path);
      });

      // Arrow marker
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
      marker.setAttribute('id', 'arrow');
      marker.setAttribute('viewBox', '0 0 10 10');
      marker.setAttribute('refX', '10'); marker.setAttribute('refY', '5');
      marker.setAttribute('markerWidth', '8'); marker.setAttribute('markerHeight', '8');
      marker.setAttribute('orient', 'auto-start-reverse');
      const arrowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      arrowPath.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
      arrowPath.setAttribute('fill', '#30363d');
      marker.appendChild(arrowPath);
      defs.appendChild(marker);
      svg.appendChild(defs);

      // Draw boxes
      boxes.forEach(b => {
        if (b.level === 'label') {
          const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          txt.setAttribute('x', b.x); txt.setAttribute('y', b.y + 25);
          txt.setAttribute('fill', '#8b949e'); txt.setAttribute('font-size', '12');
          txt.setAttribute('font-style', 'italic');
          txt.textContent = b.text;
          svg.appendChild(txt);
          return;
        }
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', b.x); rect.setAttribute('y', b.y);
        rect.setAttribute('width', b.w); rect.setAttribute('height', b.h);
        rect.setAttribute('rx', '6');
        rect.setAttribute('fill', '#161b22');
        rect.setAttribute('stroke', b.color);
        rect.setAttribute('stroke-width', b.level === 'L0' ? '2.5' : '1.5');
        svg.appendChild(rect);

        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        txt.setAttribute('x', b.x + b.w / 2); txt.setAttribute('y', b.y + b.h / 2 + 5);
        txt.setAttribute('text-anchor', 'middle');
        txt.setAttribute('fill', b.color);
        txt.setAttribute('font-size', b.level === 'L0' ? '14' : '12');
        txt.setAttribute('font-weight', b.level === 'L0' ? '700' : '500');
        txt.setAttribute('font-family', '-apple-system, sans-serif');
        txt.textContent = b.text;
        svg.appendChild(txt);
      });

      // Level labels
      const labels = [
        { y: 30, text: 'Parent Bundle', x: 5 },
        { y: 120, text: 'L1 Children', x: 5 },
        { y: 260, text: 'L2 (Burst Fees)', x: 5 },
      ];
      labels.forEach(l => {
        const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        t.setAttribute('x', l.x); t.setAttribute('y', l.y + 80);
        t.setAttribute('fill', '#484f58'); t.setAttribute('font-size', '10');
        t.setAttribute('font-family', '-apple-system, sans-serif');
        t.setAttribute('transform', `rotate(-90, ${l.x}, ${l.y + 80})`);
        t.textContent = l.text;
        svg.appendChild(t);
      });

      container.appendChild(svg);
    })();

    // ── SVG Diagram: Object Mapping ──
    (function() {
      const container = document.getElementById('diagram-mapping');
      const w = 800, h = 200;
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', w);
      svg.setAttribute('height', h);
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.style.maxWidth = '100%';

      const cpqBoxes = [
        { x: 20,  y: 30, w: 200, h: 36, text: 'SBQQ__ProductOption__c' },
        { x: 20,  y: 80, w: 200, h: 36, text: 'SBQQ__ProductFeature__c' },
        { x: 20,  y: 130, w: 200, h: 36, text: 'Product2' },
      ];
      const rcaBoxes = [
        { x: 500, y: 30, w: 260, h: 36, text: 'ProductRelatedComponent' },
        { x: 500, y: 80, w: 260, h: 36, text: 'ProductComponentGroup' },
        { x: 500, y: 130, w: 260, h: 36, text: 'Product2 (with Type field)' },
      ];

      // Labels
      const cpqLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      cpqLabel.setAttribute('x', 120); cpqLabel.setAttribute('y', 18);
      cpqLabel.setAttribute('text-anchor', 'middle');
      cpqLabel.setAttribute('fill', '#f85149'); cpqLabel.setAttribute('font-size', '13');
      cpqLabel.setAttribute('font-weight', '700');
      cpqLabel.textContent = 'CPQ (Source)';
      svg.appendChild(cpqLabel);

      const rcaLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      rcaLabel.setAttribute('x', 630); rcaLabel.setAttribute('y', 18);
      rcaLabel.setAttribute('text-anchor', 'middle');
      rcaLabel.setAttribute('fill', '#3fb950'); rcaLabel.setAttribute('font-size', '13');
      rcaLabel.setAttribute('font-weight', '700');
      rcaLabel.textContent = 'RCA (Target)';
      svg.appendChild(rcaLabel);

      function drawBox(b, color) {
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', b.x); rect.setAttribute('y', b.y);
        rect.setAttribute('width', b.w); rect.setAttribute('height', b.h);
        rect.setAttribute('rx', '5');
        rect.setAttribute('fill', '#161b22'); rect.setAttribute('stroke', color);
        rect.setAttribute('stroke-width', '1.5');
        svg.appendChild(rect);
        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        txt.setAttribute('x', b.x + b.w / 2); txt.setAttribute('y', b.y + b.h / 2 + 5);
        txt.setAttribute('text-anchor', 'middle');
        txt.setAttribute('fill', '#e6edf3'); txt.setAttribute('font-size', '12');
        txt.setAttribute('font-family', "'Fira Code', monospace");
        txt.textContent = b.text;
        svg.appendChild(txt);
      }

      cpqBoxes.forEach(b => drawBox(b, '#f85149'));
      rcaBoxes.forEach(b => drawBox(b, '#3fb950'));

      // Arrows
      for (let i = 0; i < 3; i++) {
        const y = cpqBoxes[i].y + cpqBoxes[i].h / 2;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', cpqBoxes[i].x + cpqBoxes[i].w);
        line.setAttribute('y1', y);
        line.setAttribute('x2', rcaBoxes[i].x);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', '#58a6ff');
        line.setAttribute('stroke-width', '2');
        line.setAttribute('stroke-dasharray', '6,4');
        svg.appendChild(line);

        // Arrow head
        const tri = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        const ax = rcaBoxes[i].x - 2;
        tri.setAttribute('points', `${ax},${y} ${ax - 10},${y - 5} ${ax - 10},${y + 5}`);
        tri.setAttribute('fill', '#58a6ff');
        svg.appendChild(tri);
      }

      container.appendChild(svg);
    })();
</script>

<!-- Konami Code Easter Egg: Matrix Rain -->
<canvas id="matrixCanvas" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;"></canvas>
<script>
(function(){
    // Konami Code: up up down down left right left right b a enter
    const konamiSequence = [
        'ArrowUp','ArrowUp','ArrowDown','ArrowDown',
        'ArrowLeft','ArrowRight','ArrowLeft','ArrowRight',
        'KeyB','KeyA','Enter'
    ];
    let konamiIndex = 0;
    let matrixActive = false;
    let matrixRainId = null;

    document.addEventListener('keydown', function(e) {
        const expected = konamiSequence[konamiIndex];
        if (e.code === expected || e.key === expected) {
            konamiIndex++;
            if (konamiIndex === konamiSequence.length) {
                konamiIndex = 0;
                matrixActive ? stopMatrixRain() : startMatrixRain();
                matrixActive = !matrixActive;
            }
        } else {
            konamiIndex = 0;
        }
    });

    function startMatrixRain() {
        const canvas = document.getElementById('matrixCanvas');
        if (!canvas || matrixRainId) return;
        document.body.classList.add('matrix-active');
        canvas.style.display = 'block';
        canvas.style.pointerEvents = 'none';
        const ctx = canvas.getContext('2d');

        const chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ:・."=*+-<>¦|';
        const charArr = Array.from(chars);
        const fontSize = 14;
        let columns, drops;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            columns = Math.floor(canvas.width / fontSize);
            const oldDrops = drops || [];
            drops = [];
            for (let i = 0; i < columns; i++) {
                drops[i] = oldDrops[i] !== undefined ? oldDrops[i] : Math.random() * -100;
            }
        }
        resize();
        window._matrixResize = resize;
        window.addEventListener('resize', window._matrixResize);

        let frameCount = 0;
        function draw() {
            frameCount++;
            if (frameCount % 2 !== 0) {
                matrixRainId = requestAnimationFrame(draw);
                return;
            }
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = fontSize + 'px Courier New';

            for (let i = 0; i < columns; i++) {
                const ch = charArr[Math.floor(Math.random() * charArr.length)];
                const y = drops[i] * fontSize;

                // Bright head with glow
                ctx.shadowBlur = 8;
                ctx.shadowColor = 'rgba(0,255,65,0.6)';
                ctx.fillStyle = '#aaffaa';
                ctx.fillText(ch, i * fontSize, y);

                // Dimmer trail character
                ctx.shadowBlur = 0;
                ctx.fillStyle = 'rgba(0,255,65,0.8)';
                const ch2 = charArr[Math.floor(Math.random() * charArr.length)];
                if (y - fontSize > 0) ctx.fillText(ch2, i * fontSize, y - fontSize);

                if (y > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
            matrixRainId = requestAnimationFrame(draw);
        }
        matrixRainId = requestAnimationFrame(draw);
    }

    function stopMatrixRain() {
        if (matrixRainId) {
            cancelAnimationFrame(matrixRainId);
            matrixRainId = null;
        }
        document.body.classList.remove('matrix-active');
        const canvas = document.getElementById('matrixCanvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.display = 'none';
        }
        if (window._matrixResize) {
            window.removeEventListener('resize', window._matrixResize);
            delete window._matrixResize;
        }
    }
})();
</script>

</body>
</html>
